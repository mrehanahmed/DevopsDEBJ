#!groovy
import groovy.json.JsonSlurper

String extractJson(String raw) {
    def start = raw.indexOf('{')
    if (start < 0) {
        error "No JSON found in output:\n${raw}"
    }
    return raw.substring(start).trim()
}

node {

    def BUILD_NUMBER = env.BUILD_NUMBER
    def HUB_ORG = env.HUB_ORG_DH
    def SFDC_HOST = env.SFDC_HOST_DH
    def JWT_KEY_CRED_ID = env.JWT_CRED_ID_DH
    def CONNECTED_APP_CONSUMER_KEY = env.CONNECTED_APP_CONSUMER_KEY_DH
    def toolbelt = tool 'toolbelt'

    // Only store simple serializable values
    def testCoverage = 0
    def deployStatus = "NOT RUN"
    def testSummary = ""
    def deploySummary = ""
    def shouldDeploy = false

    stage('Checkout Source') {
        checkout scm
    }

    withCredentials([file(credentialsId: JWT_KEY_CRED_ID, variable: 'jwt_key_file')]) {

        stage('Authorize Org') {
            def rc = isUnix() ?
                sh(returnStatus: true, script: """
                    ${toolbelt} org login jwt \
                    --client-id ${CONNECTED_APP_CONSUMER_KEY} \
                    --username ${HUB_ORG} \
                    --jwt-key-file ${jwt_key_file} \
                    --set-default-dev-hub \
                    --instance-url ${SFDC_HOST}
                """) :
                bat(returnStatus: true, script: """
                    ${toolbelt} org login jwt --client-id ${CONNECTED_APP_CONSUMER_KEY} --username ${HUB_ORG} --jwt-key-file ${jwt_key_file} --set-default-dev-hub --instance-url ${SFDC_HOST}
                """)

            if (rc != 0) error "Hub org authorization failed"
        }

        stage('Run Apex Tests') {
            def rawTest = isUnix() ?
                sh(returnStdout: true, script: "${toolbelt} apex run test --target-org ${HUB_ORG} --code-coverage --json") :
                bat(returnStdout: true, script: "${toolbelt} apex run test --target-org ${HUB_ORG} --code-coverage --json")

            def cleanTest = extractJson(rawTest)
            def json = new JsonSlurper().parseText(cleanTest)

            testCoverage = json?.result?.summary?.orgWideCoverage ?: 0
            testSummary = "Test Run ID: ${json?.result?.testRunId}, Coverage: ${testCoverage}%"

            shouldDeploy = testCoverage >= 75
        }

        stage('Conditional Deployment') {
            if (!shouldDeploy) {
                deployStatus = "SKIPPED (coverage ${testCoverage}%)"
                deploySummary = deployStatus
                return
            }

            def rawDeploy = isUnix() ?
                sh(returnStdout: true, script: "${toolbelt} project deploy start --manifest manifest/package.xml --target-org ${HUB_ORG} --json") :
                bat(returnStdout: true, script: "${toolbelt} project deploy start --manifest manifest/package.xml --target-org ${HUB_ORG} --json")

            def cleanDeploy = extractJson(rawDeploy)
            def json = new JsonSlurper().parseText(cleanDeploy)

            deployStatus = json.status == 0 ? "SUCCESS" : "FAILED"
            deploySummary = "Deploy Status: ${deployStatus}, ID: ${json?.result?.id}"
        }
    }

    stage('Output Results') {
        echo "============================================="
        echo "  SALESFORCE CI RESULT - BUILD #${BUILD_NUMBER}"
        echo "============================================="
        echo "Org: ${HUB_ORG}"
        echo ""
        echo "TEST RESULTS"
        echo "------------"
        echo "${testSummary}"
        echo ""
        echo "DEPLOYMENT"
        echo "----------"
        echo "Status: ${deployStatus}"
        echo "${deploySummary}"
        echo "============================================="
    }
}
