#!groovy
import groovy.json.JsonSlurper

// --- SAFE JSON EXTRACTOR (WORKS ON WINDOWS/UNIX) ---
String extractJson(String raw) {
    def start = raw.indexOf('{')
    if (start < 0) {
        error "No JSON found in output:\n${raw}"
    }
    return raw.substring(start).trim()
}

node {

    def BUILD_NUMBER = env.BUILD_NUMBER
    def HUB_ORG = env.HUB_ORG_DH
    def SFDC_HOST = env.SFDC_HOST_DH
    def JWT_KEY_CRED_ID = env.JWT_CRED_ID_DH
    def CONNECTED_APP_CONSUMER_KEY = env.CONNECTED_APP_CONSUMER_KEY_DH
    def toolbelt = tool 'toolbelt'

    def testResult
    def testCoverage = 0
    def deployResult
    def shouldDeploy = false

    stage('Checkout Source') {
        checkout scm
    }

    withCredentials([file(credentialsId: JWT_KEY_CRED_ID, variable: 'jwt_key_file')]) {

        stage('Authorize Org') {
            def rc

            if (isUnix()) {
                rc = sh returnStatus: true, script: """
                    ${toolbelt} org login jwt \
                    --client-id ${CONNECTED_APP_CONSUMER_KEY} \
                    --username ${HUB_ORG} \
                    --jwt-key-file ${jwt_key_file} \
                    --set-default-dev-hub \
                    --instance-url ${SFDC_HOST}
                """
            } else {
                rc = bat returnStatus: true, script: """
                    ${toolbelt} org login jwt --client-id ${CONNECTED_APP_CONSUMER_KEY} --username ${HUB_ORG} --jwt-key-file ${jwt_key_file} --set-default-dev-hub --instance-url ${SFDC_HOST}
                """
            }

            if (rc != 0) {
                error "Hub org authorization failed"
            }
        }

        stage('Run Apex Tests') {
            echo "Running Apex tests..."

            def rawTest

            if (isUnix()) {
                rawTest = sh returnStdout: true,
                    script: "${toolbelt} apex run test --target-org ${HUB_ORG} --code-coverage --json"
            } else {
                rawTest = bat returnStdout: true,
                    script: "${toolbelt} apex run test --target-org ${HUB_ORG} --code-coverage --json"
            }

            echo "RAW TEST OUTPUT:"
            echo rawTest

            def cleanTest = extractJson(rawTest)
            def jsonTest = new JsonSlurper().parseText(cleanTest)

            testResult = jsonTest

            if (jsonTest?.result?.summary?.orgWideCoverage != null) {
                testCoverage = jsonTest.result.summary.orgWideCoverage
            }

            echo "Org-wide Coverage = ${testCoverage}%"

            if (testCoverage >= 75) {
                echo "Coverage sufficient. Deployment allowed."
                shouldDeploy = true
            } else {
                echo "Coverage too low (${testCoverage}%). Deployment skipped."
                shouldDeploy = false
            }
        }

        stage('Conditional Deployment') {

            if (!shouldDeploy) {
                deployResult = "SKIPPED â€” Coverage ${testCoverage}%"
                echo deployResult
                return
            }

            echo "Deploying metadata..."

            def rawDeploy
            if (isUnix()) {
                rawDeploy = sh returnStdout: true,
                    script: "${toolbelt} project deploy start --manifest manifest/package.xml --target-org ${HUB_ORG} --json"
            } else {
                rawDeploy = bat returnStdout: true,
                    script: "${toolbelt} project deploy start --manifest manifest/package.xml --target-org ${HUB_ORG} --json"
            }

            echo "RAW DEPLOY OUTPUT:"
            echo rawDeploy

            def cleanDeploy = extractJson(rawDeploy)
            deployResult = new JsonSlurper().parseText(cleanDeploy)
        }
    }

    stage('Send Email Notification') {
        echo "Sending email..."

        def subject = "SF Deployment Result (Build #${BUILD_NUMBER})"
        def body = """
Build Number: ${BUILD_NUMBER}
Org: ${HUB_ORG}

Test Coverage: ${testCoverage}%
Deployment Status: ${shouldDeploy ? "DEPLOYED" : "NOT DEPLOYED"}

Test Run Result:
${testResult}

Deploy Result:
${deployResult}
"""

        emailext(
            to: 'admin@example.com',
            subject: subject,
            body: body
        )
    }
}
