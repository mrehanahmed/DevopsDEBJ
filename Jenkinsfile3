pipeline {
    agent any

    environment {
        SF_USERNAME = 'your-username'
    }

    stages {

        stage('Auth to Org') {
            steps {
                echo "\u001B[32mâœ” Authorizing ${SF_USERNAME}\u001B[0m"

                withCredentials([file(credentialsId: 'jwt-key', variable: 'JWT_KEY')]) {
                    bat """
                    sf org login jwt ^
                        --client-id 3MVG9... ^
                        --username ${SF_USERNAME} ^
                        --jwt-key-file "%JWT_KEY%" ^
                        --alias targetOrg ^
                        --set-default
                    """
                }
            }
        }

        stage('Run Apex Tests') {
            steps {
                echo "\u001B[33mğŸš€ Running Apex Testsâ€¦\u001B[0m"

                script {
                    // Run async test
                    def testRunId = bat(
                        label: 'Run Tests',
                        returnStdout: true,
                        script: 'sf apex run test --tests "MyTestClass" --json'
                    ).trim()

                    // Extract ONLY the testRunId
                    def runId = readJSON(text: testRunId).result.testRunId
                    echo "\u001B[33mâ³ Waiting for test run ${runId}...\u001B[0m"

                    // Poll loop
                    timeout(time: 8, unit: 'MINUTES') {
                        waitUntil {

                            def statusJson = bat(
                                returnStdout: true,
                                script: "sf apex get test -i ${runId} --json"
                            ).trim()

                            def status = readJSON(text: statusJson).result.summary.status

                            echo "Current Status: ${status}"

                            if (status == 'Completed') {
                                return true
                            }

                            sleep 8
                            return false
                        }
                    }

                    // Fetch results â€“ again extract only primitives
                    def resultsJson = bat(
                        returnStdout: true,
                        script: "sf apex get test -i ${runId} --json"
                    ).trim()

                    def summary = readJSON(text: resultsJson).result.summary

                    echo "------------------------------------"
                    echo "Apex Test Summary:"
                    echo "Pass: ${summary.passRate}%"
                    echo "Tests Run: ${summary.testsRan}"
                    echo "Failures: ${summary.failures}"
                    echo "Status: ${summary.status}"
                    echo "------------------------------------"

                    if (summary.failures > 0) {
                        error("âŒ Apex tests failed.")
                    }
                }
            }
        }
    }
}
