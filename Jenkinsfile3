#!groovy
import groovy.json.JsonSlurper

// --- UTILITY: extract JSON from Salesforce outputs safely ---
String extractJson(String raw) {
    def start = raw.indexOf('{')
    if (start < 0) {
        error "No JSON object found:\n${raw}"
    }
    return raw.substring(start).trim()
}

// --- UTILITY: color output ---
String green(String msg) { return "\u001B[32m${msg}\u001B[0m" }
String red(String msg)   { return "\u001B[31m${msg}\u001B[0m" }
String yellow(String msg){ return "\u001B[33m${msg}\u001B[0m" }

node {

    def HUB_ORG       = env.HUB_ORG_DH
    def SFDC_HOST     = env.SFDC_HOST_DH
    def JWT_KEY_CRED  = env.JWT_CRED_ID_DH
    def CONSUMER_KEY  = env.CONNECTED_APP_CONSUMER_KEY_DH
    def toolbelt      = tool 'toolbelt'

    // Serializable values only
    def testCoverage = 0
    def testRunId    = ""
    def deployStatus = "NOT RUN"
    def rollbackStatus = "NOT REQUIRED"

    stage('Checkout') {
        checkout scm
    }

    withCredentials([file(credentialsId: JWT_KEY_CRED, variable: 'JWTKEY')]) {

        // -------------------------------------------------------
        // 1. LOGIN
        // -------------------------------------------------------
        stage('Authorize Org') {
            def rc = bat(returnStatus: true, script: """
                ${toolbelt} org login jwt --client-id ${CONSUMER_KEY} --username ${HUB_ORG} --jwt-key-file "%JWTKEY%" --set-default-dev-hub --instance-url ${SFDC_HOST}
            """)

            if (rc != 0) error red("Authorization Failed")
            echo green("âœ” Authorized ${HUB_ORG}")
        }

        // -------------------------------------------------------
        // 2. RUN TESTS + WAIT + GET COVERAGE
        // -------------------------------------------------------
        stage('Run Apex Tests') {

            echo yellow("ðŸš€ Running Apex Testsâ€¦")

            def raw = bat(returnStdout: true, script: """
                ${toolbelt} apex run test --target-org ${HUB_ORG} --code-coverage --json
            """)

            def json = new JsonSlurper().parseText(extractJson(raw))
            testRunId = json?.result?.testRunId

            echo yellow("â³ Waiting for test run ${testRunId}...")

            // --- poll results until finished ---
            sleep(8)   // simple wait (SF CLI waits automatically in latest versions)

            def rawRes = bat(returnStdout: true, script: """
                ${toolbelt} apex get test-result --test-run-id ${testRunId} --target-org ${HUB_ORG} --json
            """)

            writeFile file: "test-result.json", text: rawRes
            archiveArtifacts artifacts: "test-result.json", fingerprint: true

            def resJson = new JsonSlurper().parseText(extractJson(rawRes))
            testCoverage = resJson?.result?.summary?.orgWideCoverage ?: 0

            echo green("âœ” Test coverage: ${testCoverage}%")
        }

        // -------------------------------------------------------
        // 3. DEPLOY IF COVERAGE >= 75%
        // -------------------------------------------------------
        stage('Deploy If Coverage Good') {

            if (testCoverage < 75) {
                deployStatus = "SKIPPED"
                echo red("âŒ Coverage = ${testCoverage}%. Deployment skipped.")
                return
            }

            echo green("ðŸš€ Coverage OK (${testCoverage}%). Deployingâ€¦")

            def rawDep = bat(returnStdout: true, script: """
                ${toolbelt} project deploy start --manifest manifest/package.xml --target-org ${HUB_ORG} --wait 10 --json
            """)

            writeFile file: "deploy-result.json", text: rawDep
            archiveArtifacts artifacts: "deploy-result.json", fingerprint: true

            def depJson = new JsonSlurper().parseText(extractJson(rawDep))

            deployStatus = depJson.status == 0 ? "SUCCESS" : "FAILED"

            if (deployStatus == "SUCCESS") {
                echo green("âœ” Deployment Successful")
                return
            }

            echo red("âŒ Deployment Failed")
        }

        // -------------------------------------------------------
        // 4. ROLLBACK ON FAILURE
        // -------------------------------------------------------
        stage('Rollback If Needed') {

            if (deployStatus != "FAILED") {
                rollbackStatus = "Not Required"
                return
            }

            echo yellow("âš  Deployment failed. Rolling backâ€¦")

            // Assumes last successful MDAPI is stored in artifacts/mdapi.zip
            if (fileExists("rollback-mdapi.zip")) {

                def rc = bat(returnStatus: true, script: """
                    ${toolbelt} mdapi deploy --deploy-dir rollback-mdapi.zip --target-org ${HUB_ORG} --ignore-conflicts --wait 10 --json
                """)

                rollbackStatus = rc == 0 ? "SUCCESS" : "FAILED"

                echo(rollbackStatus == "SUCCESS" ?
                        green("âœ” Rollback Successful") :
                        red("âŒ Rollback Failed"))

            } else {
                rollbackStatus = "NO ROLLBACK FILE FOUND"
                echo red("âŒ No rollback artifact found. Skipping rollback.")
            }
        }
    }

    // -------------------------------------------------------
    // 5. OUTPUT SUMMARY (COLORIZED)
    // -------------------------------------------------------
    stage('RESULT SUMMARY') {

        echo "=============================================="
        echo "      SALESFORCE PIPELINE RESULT"
        echo "=============================================="
        echo "Org: ${HUB_ORG}"
        echo "Test Run: ${testRunId}"
        echo "Coverage: ${testCoverage}%"
        echo "Deploy:  ${deployStatus == 'SUCCESS' ? green('SUCCESS') : red(deployStatus)}"
        echo "Rollback: ${rollbackStatus}"
        echo "=============================================="
    }
}
