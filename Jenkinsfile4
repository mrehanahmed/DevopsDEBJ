stage('Notify Slack') {
    when {
        expression { return env.SLACK_CHANNEL }
    }
    steps {
        script {
            slackSend(
                channel: env.SLACK_CHANNEL,
                message: "Branch: ${BRANCH}\nOrg: ${TARGET_ENV}\nCoverage: ${COVERAGE}%\nDeployment: ${DEPLOY_STATUS}"
            )
        }
    }
}

stage('Notify Teams') {
    when {
        expression { return env.TEAMS_ENABLED == 'true' }
    }
    steps {
        withCredentials([string(credentialsId: 'TEAMS_WEBHOOK_URL', variable: 'TEAMS_URL')]) {
            script {
                def json = """{
                    "text": "Branch: ${BRANCH}\nOrg: ${TARGET_ENV}\nCoverage: ${COVERAGE}%\nDeployment: ${DEPLOY_STATUS}"
                }"""

                writeFile file: 'teams_payload.json', text: json

                bat """
                    curl -X POST -H "Content-Type: application/json" -d @teams_payload.json "%TEAMS_URL%"
                """
            }
        }
    }
}
